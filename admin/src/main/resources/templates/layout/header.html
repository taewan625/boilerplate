<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<th:block th:fragment="header-fragment" >
    <nav
        class="layout-navbar container-fluid navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme"
        id="layout-navbar"
    >
        <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
            <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
                <i class="bx bx-menu bx-sm"></i>
            </a>
        </div>

        <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
            <!-- Search -->
                  <div class="navbar-nav align-items-center">
                    <div class="nav-item d-flex align-items-center">
                            <label for="exhibition"></label>
                            <select id="exhibition" class="form-select w-px-300">
                                <option th:each="option : ${session.exhibitions}"
                                        th:value="${option.id}"
                                        th:text="${option.exhibitionName}"
                                        th:selected="${option.used}"
                                >
                            </select>
                    </div>
                  </div>
            <!-- /Search -->
            <div class="navbar-nav align-items-center ms-auto">
                <span class="navbar-brand" th:text="${session.adminName+'('+session.role+')'}"></span>
            </div>
            <ul class="navbar-nav flex-row align-items-center ">
                <!-- Place this tag where you want the button to render. -->
                <!--        <li class="nav-item lh-1 me-3">
                          <a
                                  class="github-button"
                                  href="https://github.com/themeselection/sneat-html-admin-template-free"
                                  data-icon="octicon-star"
                                  data-size="large"
                                  data-show-count="true"
                                  aria-label="Star themeselection/sneat-html-admin-template-free on GitHub"
                          >Star</a
                          >
                        </li>-->

                <!-- User -->
                <li class="nav-item navbar-dropdown dropdown-user dropdown">
                    <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                        <div class="avatar avatar-online">
                            <img src="/static/img/logo/exporum.png" alt class="w-px-38 h-auto" />
                        </div>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="#">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar avatar-online">
                                            <img src="/static/img/logo/exporum.png" alt class="w-px-38 h-auto" />
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <span class="fw-semibold d-block" th:text="${session.adminName}">홍길동</span>
                                        <small class="text-muted" th:text="${session.role}">Admin</small>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li>
                            <div class="dropdown-divider"></div>
                        </li>
                        <li>
                            <a class="dropdown-item" id="link-change-password">
                                <i class="bx bx-key me-2"></i>
                                <span class="align-middle">Change Password</span>
                            </a>
                        </li>
                        <li>
                            <div class="dropdown-divider"></div>
                        </li>
                        <li>
                            <a class="dropdown-item" href="/logout" onclick="clearSessionStorage();">
                                <i class="bx bx-power-off me-2"></i>
                                <span class="align-middle">Log Out</span>
                            </a>
                        </li>
                    </ul>
                </li>
                <!--/ User -->
            </ul>
        </div>
    </nav>



    <div class="modal fade" id="password-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog">
            <form class="modal-content" id="change-password-form">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-registry-title">CHANGE PASSWORD</h5>
                    <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                            id="btn-x-change-password"
                    ></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="current-password" class="form-label">Current Password</label>
                            <input
                                    type="password"
                                    id="current-password"
                                    class="form-control"
                                    name="currentPassword"
                                    placeholder="&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;"
                                    aria-describedby="password"
                                    required
                                    autocomplete="currentPassword"
                            />
                            <input type="hidden" name="username" value="hidden-username" autocomplete="username" hidden>
                        </div>
                        <div class="col-12">
                            <label for="new-password" class="form-label">New Password</label>
                            <input
                                    type="password"
                                    id="new-password"
                                    class="form-control"
                                    name="newPassword"
                                    placeholder="&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;"
                                    aria-describedby="password"
                                    required
                                    autocomplete="newPassword"
                            />
                        </div>
                        <div class="col-12">
                            <label for="confirm-new-password" class="form-label">Confirm New Password</label>
                            <input
                                    type="password"
                                    id="confirm-new-password"
                                    class="form-control"
                                    name="confirmNewPassword"
                                    placeholder="&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;&#xb7;"
                                    aria-describedby="password"
                                    required
                                    autocomplete="confirmNewPassword"
                            />
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" id="btn-cancel-change-password">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btn-change-password">Change</button>
                </div>
            </form>
        </div>
    </div>


    <script th:inline="javascript" defer>
        window.addEventListener('load', () => {
            const initialPassword = /*[[${session.initialPassword}]]*/ false
            const passwordModalEl = document.getElementById('password-modal');
            const passwordModalInstance = bootstrap.Modal.getInstance(passwordModalEl) || new bootstrap.Modal(passwordModalEl);
            const changePasswordForm = $("#change-password-form");

            if(initialPassword){
                $('#btn-x-change-password').addClass('d-none')
                $('#btn-cancel-change-password').addClass('d-none')
                changePasswordForm[0].reset();
                changePasswordForm.validate().resetForm();
                $(".form-control").removeClass("error");

                passwordModalInstance.show();
            }

            $('#link-change-password').click(()=>{
                $('#btn-x-change-password').removeClass('d-none')
                $('#btn-cancel-change-password').removeClass('d-none')
                changePasswordForm[0].reset();
                changePasswordForm.validate().resetForm();
                $(".form-control").removeClass("error");

                passwordModalInstance.show();
            })

            $.validator.addMethod("passwordCheck", function (value) {
                return /^(?=.*[a-z])(?=.*\d)(?=.*[!@#$%^&*()_+=-]).{8,}$/.test(value);
            }, "비밀번호는 8자 이상, 소문자, 숫자, 특수문자를 포함해야 합니다.");
            ///^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+=-]).{8,}$/

            changePasswordForm.validate({
                rules: {
                    currentPassword: {
                        required: true
                    },
                    newPassword: {
                        required: true,
                        minlength: 8,
                        maxlength: 20,
                        passwordCheck: true
                    },
                    confirmNewPassword: {
                        required: true,
                        equalTo: "#new-password"
                    }
                },
                messages: {
                    currentPassword: {
                        required: "현재 비밀번호를 입력하세요."
                    },
                    newPassword: {
                        required: "새 비밀번호를 입력하세요.",
                        minlength: "비밀번호는 최소 8자 이상이어야 합니다.",
                        maxlength: "비밀번호는 최대 20자까지 입력 가능합니다."
                    },
                    confirmNewPassword: {
                        required: "비밀번호 확인을 입력하세요.",
                        equalTo: "비밀번호가 일치하지 않습니다."
                    }
                }
            });

            $('#btn-change-password').click(()=>{
                if($("#change-password-form").valid()){
                    const password = $("#current-password").val();;
                    const newPassword = $("#new-password").val();
                    const data = {
                        password : password,
                        newPassword: newPassword
                    }

                    $.ajax({
                        type: "POST",
                        url: `/api/v1/admin/password`,
                        data: JSON.stringify(data),
                        contentType: "application/json",
                        dataType: "JSON",
                        success: (res, textStatus, jqXHR) =>{
                            if(res.success) {
                                toastr.success('',"비밀번호가 변경되었습니다.",{timeOut:1500})

                                passwordModalInstance.hide();
                            }else{
                                toastr.error('',res.message,{timeOut:1500})
                            }
                        },
                        beforeSend: () =>{loadingStart()} ,
                        complete:() =>{loadingExit()},
                        error: (jqXHR, textStatus, errorThrown) => {},
                        async: false
                    });
                }
            });
        })
    </script>
</th:block>

</html>